<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Naija Doc</a>
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarNav"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link active" href="{% url 'nurse_home' %}">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'create_case' %}">Add Case</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'create_student' %}">Add Student</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="">Dispense</a>
        </li>
      </ul>
      <span class="navbar-text ms-auto"> {{ user.username }} </span>
    </div>
  </div>
</nav>

<h2 class="mb-4">Create Case</h2>
<form method="post" class="container">
  {% csrf_token %}
  <div class="case-form">
    <div class="mb-3 position-relative">
      <label for="student-search" class="form-label">Student</label>
      <input
        type="text"
        id="student-search"
        class="form-control"
        placeholder="Search student..."
        autocomplete="off"
      />
      <input type="hidden" name="student" id="student-id" />
      <div id="student-results" class="search-results list-group"></div>
    </div>
    <div class="mb-3">
      <label name="notes" for="id_notes" class="form-label">Notes</label>
      <textarea
        name="notes"
        id="id_notes"
        class="form-control"
        rows="4"
        placeholder="Enter case notes..."
      ></textarea>
    </div>
  </div>
  <h3 class="mb-3">Medications</h3>
  <div id="medications">
    <div class="medication-form border rounded p-3 mb-3 bg-light">
      <div class="row mb-2">
        <div class="col-md-6 mb-2">
          <label for="id_medication-0-drug" class="form-label">Drug</label>
          <select
            name="medication-0-drug"
            id="id_medication-0-drug"
            class="form-select"
          >
            <option value="">---------</option>
            {% for drug in drugs %}
            <option value="{{ drug.id }}">{{ drug.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6 d-flex align-items-end gap-3">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              name="medication-0-morning"
              id="id_medication-0-morning"
            />
            <label class="form-check-label" for="id_medication-0-morning"
              >Morning</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              name="medication-0-afternoon"
              id="id_medication-0-afternoon"
            />
            <label class="form-check-label" for="id_medication-0-afternoon"
              >Afternoon</label
            >
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              name="medication-0-night"
              id="id_medication-0-night"
            />
            <label class="form-check-label" for="id_medication-0-night"
              >Night</label
            >
          </div>
        </div>
      </div>
      <div class="row mb-2">
        <div class="col-md-4">
          <label for="id_medication-0-days" class="form-label">Days</label>
          <input
            type="number"
            name="medication-0-days"
            id="id_medication-0-days"
            min="1"
            class="form-control"
          />
        </div>
      </div>
      <button
        type="button"
        class="remove-medication btn btn-outline-danger btn-sm mt-2"
      >
        Remove
      </button>
    </div>
  </div>
  <button
    type="button"
    id="add-medication"
    class="btn btn-outline-primary mb-3"
  >
    Add Medication
  </button>

  <br />
  <input type="hidden" name="medication-TOTAL_FORMS" value="1" />
  <input type="hidden" name="medication-INITIAL_FORMS" value="0" />
  <input type="hidden" name="medication-MIN_NUM_FORMS" value="0" />
  <input type="hidden" name="medication-MAX_NUM_FORMS" value="1000" />
  <button type="submit" class="btn btn-success">Submit</button>
</form>

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
/>

<style>
  .search-results {
    position: absolute;
    z-index: 1000;
    width: 100%;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0 0 0.25rem 0.25rem;
    max-height: 200px;
    overflow-y: auto;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    display: none;
  }
  .search-result-item,
  .list-group-item {
    padding: 0.5rem 1rem;
    cursor: pointer;
  }
  .search-result-item:hover,
  .list-group-item:hover {
    background: #f8f9fa;
  }
</style>

<script>
  // Navbar toggler for Bootstrap 5
  document.addEventListener('DOMContentLoaded', function () {
    var toggler = document.querySelector('.navbar-toggler');
    var navCollapse = document.getElementById('navbarNav');
    if (toggler && navCollapse) {
      toggler.addEventListener('click', function () {
        navCollapse.classList.toggle('show');
      });
    }
  });

  const students = [
    {% for student in students %}
      {
        id: "{{ student.id }}",
        name: "{{ student.name }}",
        class_level: "{{ student.level }}"
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  const searchInput = document.getElementById('student-search');
  const resultsDiv = document.getElementById('student-results');
  const studentIdInput = document.getElementById('student-id');

  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase();
    resultsDiv.innerHTML = '';
    if (query.length === 0) {
      resultsDiv.style.display = 'none';
      return;
    }
    const matches = students.filter(s => (s.name + ' ' + s.class_level).toLowerCase().includes(query));
    if (matches.length === 0) {
      resultsDiv.style.display = 'none';
      return;
    }
    matches.forEach(s => {
      const div = document.createElement('div');
      div.className = 'list-group-item list-group-item-action search-result-item';
      div.textContent = `${s.name} (${s.class_level})`;
      div.dataset.id = s.id;
      div.addEventListener('click', function() {
        searchInput.value = `${s.name} (${s.class_level})`;
        studentIdInput.value = s.id;
        resultsDiv.innerHTML = '';
        resultsDiv.style.display = 'none';
      });
      resultsDiv.appendChild(div);
    });
    resultsDiv.style.display = 'block';
  });

  document.addEventListener('click', function(e) {
    if (!resultsDiv.contains(e.target) && e.target !== searchInput) {
      resultsDiv.style.display = 'none';
    }
  });

  // Clone the empty form template for new medications
  const addBtn = document.getElementById("add-medication");
  const medicationsDiv = document.getElementById("medications");
  const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');
  addBtn.addEventListener("click", function () {
    const currentFormCount = parseInt(totalForms.value);
    const emptyForm = medicationsDiv
      .querySelector(".medication-form:last-child")
      .cloneNode(true);
    // Clear values
    emptyForm.querySelectorAll("input, select").forEach((input) => {
      if (input.type === "checkbox" || input.type === "radio") {
        input.checked = false;
      } else {
        input.value = "";
      }
    });
    // Update form index
    emptyForm.innerHTML = emptyForm.innerHTML.replaceAll(
      new RegExp(`-${currentFormCount - 1}-`, "g"),
      `-${currentFormCount}-`
    );
    medicationsDiv.appendChild(emptyForm);
    totalForms.value = parseInt(totalForms.value)  + 1;
    console.log(totalForms.value)
  });

  // Remove medication form
  medicationsDiv.addEventListener("click", function (e) {
    if (e.target.classList.contains("remove-medication")) {
      const forms = medicationsDiv.querySelectorAll(".medication-form");
      if (forms.length > 1) {
        e.target.parentElement.remove();
        totalForms.value = forms.length - 1;
      }
    }
  });
</script>
